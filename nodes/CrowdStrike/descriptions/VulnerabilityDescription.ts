/*
 * Copyright (c) Velocity BPA, LLC
 * Licensed under the Business Source License 1.1
 * Commercial use requires a separate commercial license.
 * See LICENSE file for details.
 */

import type { INodeProperties } from 'n8n-workflow';

export const vulnerabilityOperations: INodeProperties[] = [
  {
    displayName: 'Operation',
    name: 'operation',
    type: 'options',
    noDataExpression: true,
    displayOptions: {
      show: {
        resource: ['vulnerability'],
      },
    },
    options: [
      {
        name: 'Get',
        value: 'get',
        description: 'Get vulnerability details by ID',
        action: 'Get a vulnerability',
      },
      {
        name: 'Get by CVE',
        value: 'getByCve',
        description: 'Get hosts affected by a specific CVE',
        action: 'Get by CVE',
      },
      {
        name: 'Get by Host',
        value: 'getByHost',
        description: 'Get vulnerabilities for a specific host',
        action: 'Get vulnerabilities by host',
      },
      {
        name: 'Get Many',
        value: 'getAll',
        description: 'Query all vulnerabilities',
        action: 'Get many vulnerabilities',
      },
      {
        name: 'Get Remediations',
        value: 'getRemediations',
        description: 'Get remediation actions for vulnerabilities',
        action: 'Get remediations',
      },
    ],
    default: 'getAll',
  },
];

export const vulnerabilityFields: INodeProperties[] = [
  // Vulnerability ID field
  {
    displayName: 'Vulnerability ID',
    name: 'vulnerabilityId',
    type: 'string',
    required: true,
    default: '',
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['get'],
      },
    },
    description: 'The unique vulnerability ID',
  },
  // CVE ID field
  {
    displayName: 'CVE ID',
    name: 'cveId',
    type: 'string',
    required: true,
    default: '',
    placeholder: 'CVE-2021-44228',
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['getByCve', 'getRemediations'],
      },
    },
    description: 'The CVE identifier (e.g., CVE-2021-44228)',
  },
  // Device ID for getByHost
  {
    displayName: 'Device ID',
    name: 'deviceId',
    type: 'string',
    required: true,
    default: '',
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['getByHost'],
      },
    },
    description: 'The device ID to get vulnerabilities for',
  },
  // Return All toggle
  {
    displayName: 'Return All',
    name: 'returnAll',
    type: 'boolean',
    default: false,
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['getAll', 'getByHost', 'getByCve'],
      },
    },
    description: 'Whether to return all results or only up to a given limit',
  },
  // Limit
  {
    displayName: 'Limit',
    name: 'limit',
    type: 'number',
    default: 50,
    typeOptions: {
      minValue: 1,
      maxValue: 5000,
    },
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['getAll', 'getByHost', 'getByCve'],
        returnAll: [false],
      },
    },
    description: 'Max number of results to return',
  },
  // Filters for getAll
  {
    displayName: 'Filters',
    name: 'filters',
    type: 'collection',
    placeholder: 'Add Filter',
    default: {},
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['getAll'],
      },
    },
    options: [
      {
        displayName: 'Severity',
        name: 'severity',
        type: 'options',
        options: [
          { name: 'Critical', value: 'critical' },
          { name: 'High', value: 'high' },
          { name: 'Medium', value: 'medium' },
          { name: 'Low', value: 'low' },
          { name: 'Unknown', value: 'unknown' },
        ],
        default: '',
        description: 'Filter by severity level',
      },
      {
        displayName: 'Status',
        name: 'status',
        type: 'options',
        options: [
          { name: 'Open', value: 'open' },
          { name: 'Closed', value: 'closed' },
          { name: 'Reopened', value: 'reopen' },
        ],
        default: '',
        description: 'Filter by vulnerability status',
      },
      {
        displayName: 'CVE ID',
        name: 'cveId',
        type: 'string',
        default: '',
        description: 'Filter by CVE ID',
      },
      {
        displayName: 'Product Name',
        name: 'productName',
        type: 'string',
        default: '',
        description: 'Filter by affected product name',
      },
      {
        displayName: 'Host ID',
        name: 'hostId',
        type: 'string',
        default: '',
        description: 'Filter by specific host ID',
      },
      {
        displayName: 'Hostname',
        name: 'hostname',
        type: 'string',
        default: '',
        description: 'Filter by hostname',
      },
      {
        displayName: 'Suppressed',
        name: 'suppressed',
        type: 'boolean',
        default: false,
        description: 'Filter by suppression status',
      },
      {
        displayName: 'Exploit Status',
        name: 'exploitStatus',
        type: 'options',
        options: [
          { name: 'Available', value: 'available' },
          { name: 'Not Available', value: 'not_available' },
        ],
        default: '',
        description: 'Filter by exploit availability',
      },
      {
        displayName: 'Created (After)',
        name: 'createdAfter',
        type: 'dateTime',
        default: '',
        description: 'Filter vulnerabilities created after this time',
      },
      {
        displayName: 'Created (Before)',
        name: 'createdBefore',
        type: 'dateTime',
        default: '',
        description: 'Filter vulnerabilities created before this time',
      },
      {
        displayName: 'Base Score (Min)',
        name: 'baseScoreMin',
        type: 'number',
        typeOptions: {
          minValue: 0,
          maxValue: 10,
        },
        default: undefined,
        description: 'Filter by minimum CVSS base score',
      },
      {
        displayName: 'Base Score (Max)',
        name: 'baseScoreMax',
        type: 'number',
        typeOptions: {
          minValue: 0,
          maxValue: 10,
        },
        default: undefined,
        description: 'Filter by maximum CVSS base score',
      },
    ],
  },
  // Additional options
  {
    displayName: 'Options',
    name: 'options',
    type: 'collection',
    placeholder: 'Add Option',
    default: {},
    displayOptions: {
      show: {
        resource: ['vulnerability'],
        operation: ['getAll', 'getByHost', 'getByCve'],
      },
    },
    options: [
      {
        displayName: 'Sort Field',
        name: 'sort',
        type: 'options',
        options: [
          { name: 'Created Time', value: 'created_timestamp' },
          { name: 'Updated Time', value: 'updated_timestamp' },
          { name: 'Severity', value: 'cve.severity' },
          { name: 'Base Score', value: 'cve.base_score' },
        ],
        default: 'created_timestamp',
        description: 'Field to sort results by',
      },
      {
        displayName: 'Sort Order',
        name: 'sortOrder',
        type: 'options',
        options: [
          { name: 'Ascending', value: 'asc' },
          { name: 'Descending', value: 'desc' },
        ],
        default: 'desc',
        description: 'Sort order for results',
      },
      {
        displayName: 'Include Remediation',
        name: 'includeRemediation',
        type: 'boolean',
        default: false,
        description: 'Whether to include remediation details in the response',
      },
    ],
  },
];
